### 1. Таблица `users`

Хранит данные о владельцах кофеен и их статусе в системе Vendista.

```sql
CREATE TABLE IF NOT EXISTS public.users (
    id                           SERIAL PRIMARY KEY,
    telegram_id                  BIGINT UNIQUE NOT NULL,
    vendista_api_token           TEXT,
    vendista_login               TEXT, -- Encrypted
    vendista_password            TEXT, -- Encrypted
    name                         VARCHAR(255),
    first_name                   VARCHAR(255),
    last_name                    VARCHAR(255),
    user_name                    VARCHAR(255),
    language_code                VARCHAR(10),
    photo_url                    TEXT,
    setup_date                   DATE,
    tax_system                   VARCHAR(32),
    acquiring                    NUMERIC,
    registration_date            TIMESTAMPTZ,
    created_at                   TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT now(),
    updated_at                   TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT now(),
    vendista_payment_status      VARCHAR(20) DEFAULT 'active'
                                    CHECK (vendista_payment_status IN (
                                        'active','payment_required','notified'
                                    )),
    vendista_token_status        VARCHAR(20) DEFAULT 'valid'
                                    CHECK (vendista_token_status IN (
                                        'valid', 'expired', 'invalid_creds'
                                    )),
    vendista_payment_notified_at TIMESTAMPTZ
);

-- Триггер для автоматического обновления updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
  RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_timestamp_users
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE INDEX IF NOT EXISTS idx_users_payment_status
  ON public.users(vendista_payment_status);

CREATE INDEX IF NOT EXISTS idx_users_telegram_id
  ON public.users(telegram_id);
```

---

### 2. Таблица `user_access_rights`

Управляет правами доступа приглашённых пользователей к данным владельцев.

```sql
CREATE TABLE IF NOT EXISTS public.user_access_rights (
    id                              SERIAL PRIMARY KEY,
    owner_user_id                   INTEGER NOT NULL
                                       REFERENCES public.users(id)
                                       ON DELETE CASCADE,
    shared_with_telegram_id         BIGINT NOT NULL,
    shared_with_name                VARCHAR(255) NOT NULL,
    access_level                    VARCHAR(50) NOT NULL DEFAULT 'admin',
    can_receive_stock_notifications BOOLEAN     DEFAULT FALSE,
    can_receive_service_notifications BOOLEAN    DEFAULT FALSE,
    assigned_terminals_stock        INTEGER[],
    assigned_terminals_service      INTEGER[],
    timezone                        VARCHAR(100),
    created_at                      TIMESTAMPTZ  DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (owner_user_id, shared_with_telegram_id)
);
```

---

### 3. Таблица `terminals`

Кэш информации о кофейных терминалах, синхронизируемых с Vendista.

```sql
CREATE TABLE IF NOT EXISTS public.terminals (
    id                       SERIAL PRIMARY KEY,
    user_id                  INTEGER NOT NULL
                               REFERENCES public.users(id)
                               ON DELETE CASCADE,
    vendista_terminal_id     INTEGER NOT NULL,
    name                     VARCHAR(255),
    serial_number            VARCHAR(100),
    last_online_time         TIMESTAMPTZ,
    is_online                BOOLEAN     DEFAULT FALSE,
    is_active                BOOLEAN     NOT NULL DEFAULT TRUE,
    last_synced_at           TIMESTAMPTZ,
    service_interval_sales   INTEGER,
    sales_since_last_service INTEGER     DEFAULT 0,
    sales_since_cleaning     INTEGER     NOT NULL DEFAULT 0,
    created_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (user_id, vendista_terminal_id)
);

CREATE INDEX IF NOT EXISTS idx_terminals_user_id
  ON public.terminals(user_id);
```

---

### 4. Таблица `transactions`

Все финансовые транзакции из Vendista.

```sql
CREATE TABLE IF NOT EXISTS public.transactions (
    id               SERIAL PRIMARY KEY,
    user_id          INTEGER     NOT NULL
                               REFERENCES public.users(id)
                               ON DELETE CASCADE,
    coffee_shop_id   INTEGER,
    amount           NUMERIC,
    transaction_time TIMESTAMPTZ,
    result           VARCHAR(255),
    reverse_id       INTEGER,
    terminal_comment VARCHAR(255),
    card_number      VARCHAR(32),
    status           VARCHAR(64),
    bonus            NUMERIC,
    left_sum         NUMERIC,
    left_bonus       NUMERIC,
    machine_item_id  INTEGER,
    last_updated_at  TIMESTAMPTZ DEFAULT now()
);
```

---

### 5. Таблица `expenses`

Расходы, введённые вручную пользователями.

```sql
CREATE TABLE IF NOT EXISTS public.expenses (
    id            SERIAL PRIMARY KEY,
    user_id       INTEGER     NOT NULL
                        REFERENCES public.users(id)
                        ON DELETE CASCADE,
    amount        NUMERIC     NOT NULL,
    comment       TEXT,
    expense_time  TIMESTAMPTZ NOT NULL
);
```

---

### 6. Таблица `inventories`

Остатки ингредиентов на складе и в каждой стойке.

```sql
CREATE TABLE IF NOT EXISTS public.inventories (
    id                        SERIAL PRIMARY KEY,
    user_id                   INTEGER     NOT NULL
                                REFERENCES public.users(id)
                                ON DELETE CASCADE,
    terminal_id               INTEGER
                                REFERENCES public.terminals(id)
                                ON DELETE CASCADE,
    item_name                 VARCHAR(100) NOT NULL,
    location                  VARCHAR(50)  NOT NULL,
    current_stock             NUMERIC(12,3) NOT NULL DEFAULT 0,
    max_stock                 NUMERIC(12,3),
    critical_stock            NUMERIC(12,3),
    updated_at                TIMESTAMPTZ  NOT NULL DEFAULT now(),
    UNIQUE (user_id, terminal_id, item_name, location)
);

CREATE INDEX IF NOT EXISTS idx_inventories_user_location
  ON public.inventories(user_id, location);
```

---

### 7. Таблица `recipes`

Рецепты напитков, привязанные к кнопкам терминала.

```sql
CREATE TABLE IF NOT EXISTS public.recipes (
    id               SERIAL PRIMARY KEY,
    terminal_id      INTEGER     NOT NULL
                              REFERENCES public.terminals(id)
                              ON DELETE CASCADE,
    machine_item_id  INTEGER     NOT NULL,
    name             VARCHAR(255),
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (terminal_id, machine_item_id)
);
```

---

### 8. Таблица `recipe_items`

Состав рецепта: ингредиенты и их количества.

```sql
CREATE TABLE IF NOT EXISTS public.recipe_items (
    id         SERIAL PRIMARY KEY,
    recipe_id  INTEGER     NOT NULL
                          REFERENCES public.recipes(id)
                          ON DELETE CASCADE,
    item_name  VARCHAR(100) NOT NULL,
    quantity   NUMERIC(10,3) NOT NULL DEFAULT 0,
    UNIQUE (recipe_id, item_name)
);
```

---

### 9. Таблица `stand_service_settings`

Настройки задач по чистке и пополнению для каждой стойки.

```sql
CREATE TABLE IF NOT EXISTS public.stand_service_settings (
    id                       SERIAL PRIMARY KEY,
    terminal_id              INTEGER     NOT NULL
                                   REFERENCES public.terminals(id)
                                   ON DELETE CASCADE,
    cleaning_frequency       INTEGER     CHECK (cleaning_frequency > 0),
    restock_thresholds       JSONB,
    assignee_id_cleaning     BIGINT,
    assignee_id_restock      BIGINT,
    created_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (terminal_id)
);

CREATE INDEX IF NOT EXISTS idx_stand_service_settings_terminal_id
  ON public.stand_service_settings(terminal_id);

CREATE TRIGGER set_stand_service_settings_updated_at
  BEFORE UPDATE ON public.stand_service_settings
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();
```

---

### 10. Таблица `service_tasks`

Журнал задач на **cleaning** и **restock**, как автоматических, так и ручных.

```sql
CREATE TABLE IF NOT EXISTS public.service_tasks (
    id           SERIAL PRIMARY KEY,
    terminal_id  INTEGER     NOT NULL
                             REFERENCES public.terminals(id)
                             ON DELETE CASCADE,
    task_type    VARCHAR(20) NOT NULL
                             CHECK (task_type IN ('cleaning','restock')),
    status       VARCHAR(20) NOT NULL DEFAULT 'pending'
                             CHECK (status IN ('pending','completed')),
    details      JSONB,
    comment      TEXT,
    assignee_id  BIGINT,
    created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
    completed_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_service_tasks_terminal_id
  ON public.service_tasks(terminal_id);
CREATE INDEX IF NOT EXISTS idx_service_tasks_status
  ON public.service_tasks(status);
CREATE INDEX IF NOT EXISTS idx_service_tasks_task_type
  ON public.service_tasks(task_type);
```

---

### 11. Таблица `worker_logs`

Логи фоновых воркеров (импорт транзакций, очистка задач и т.д.).

```sql
CREATE TABLE IF NOT EXISTS public.worker_logs (
    id              SERIAL PRIMARY KEY,
    user_id         INTEGER
                        REFERENCES public.users(id)
                        ON DELETE CASCADE,
    job_name        VARCHAR(100) NOT NULL,
    last_run_at     TIMESTAMPTZ,
    status          VARCHAR(50),
    processed_items INTEGER,
    added_items     INTEGER,
    updated_items   INTEGER,
    error_message   TEXT,
    details         TEXT
);

CREATE INDEX IF NOT EXISTS idx_worker_logs_job_name
  ON public.worker_logs(job_name);
CREATE INDEX IF NOT EXISTS idx_worker_logs_last_run_at
  ON public.worker_logs(last_run_at);
CREATE INDEX IF NOT EXISTS idx_worker_logs_user_id
  ON public.worker_logs(user_id);
```

---

### 12. Таблица `inventory_change_log`

Журнал изменений остатков, сделанных пользователями.

```sql
CREATE TABLE IF NOT EXISTS public.inventory_change_log (
    id                     SERIAL PRIMARY KEY,
    owner_user_id          INTEGER     NOT NULL
                                   REFERENCES public.users(id)
                                   ON DELETE CASCADE,
    changed_by_telegram_id BIGINT      NOT NULL,
    change_timestamp       TIMESTAMPTZ NOT NULL DEFAULT now(),
    change_source          VARCHAR(20) NOT NULL,
    terminal_id            INTEGER
                              REFERENCES public.terminals(id)
                              ON DELETE SET NULL,
    item_name              VARCHAR(100) NOT NULL,
    quantity_before        NUMERIC(10,3) NOT NULL,
    quantity_after         NUMERIC(10,3) NOT NULL,
    is_notified            BOOLEAN     NOT NULL DEFAULT FALSE
);

CREATE INDEX IF NOT EXISTS idx_inventory_change_log_notified
  ON public.inventory_change_log(is_notified, change_timestamp);
```

---

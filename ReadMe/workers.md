# Backend Workers: Автоматизация и фоновые задачи

Этот документ описывает все фоновые процессы (воркеры), которые работают в системе, их назначение, расписание и технические детали.

---

## 1. Архитектура

В производственной среде (`production`) все воркеры управляются через **PM2** и запускаются в отдельном процессе `infocoffee-scheduler`, который определен в `ecosystem.config.js`. Это обеспечивает изоляцию от основного API-сервера и стабильность работы.

---

## 2. Обзор воркеров

### 2.1. Планировщик импорта (`schedule_imports.js`)

-   **Назначение**: Центральный узел для запуска всех задач, связанных с импортом данных из Vendista.
-   **Функциональность**:
    -   **Импорт транзакций (каждые 15 минут)**: Запускает импорт транзакций за последние 24 часа для всех активных пользователей. Это основной механизм получения данных о продажах.
    -   **Синхронизация терминалов (каждые 15 минут)**: Обновляет статусы (онлайн/офлайн) и другую информацию о кофейных аппаратах.
    -   **Ежедневный импорт (03:00 МСК)**: Запускает более полный импорт транзакций за последние сутки.
    -   **Еженедельный импорт (05:00 МСК, Воскресенье)**: Запускает импорт транзакций за последние 7 дней для полноты данных.
-   **Технические нюансы**:
    -   Использует очередь (`importQueue`) для последовательной обработки пользователей, чтобы избежать чрезмерной нагрузки на API Vendista.
    -   Различает **исторический** и **регулярный** импорт. При историческом импорте списание ингредиентов не происходит, что критически важно для корректного учета.

### 2.2. Обработчик импорта транзакций (`vendista_import_worker.js`)

-   **Назначение**: Основной "рабочий" воркер, который выполняет непосредственную загрузку и обработку транзакций из API Vendista.
-   **Функциональность**:
    -   Постранично загружает транзакции.
    -   Использует `ON CONFLICT` в PostgreSQL для умного добавления/обновления данных, избегая дубликатов.
    -   Списывает ингредиенты согласно рецептам проданных товаров.
    -   **Создает задачи**: Если после списания остаток ингредиента становится ниже критического, автоматически создает задачу на пополнение (`restock`).
-   **Технические нюансы**:
    -   Реализован механизм повторных попыток с обновлением токена при ошибках `401 Unauthorized`.
    -   Интегрирован с системой отслеживания статуса оплаты.
    -   Если для проданного товара не найден рецепт, транзакция помечается как `needs_recipe` и пропускается.
    -   Если у ингредиента в рецепте нет записи в остатках (`inventories`), он считается критическим и создается задача на пополнение.
    -   Взаимодействует с `botNotifier` для отправки уведомлений о созданных задачах.

### 2.3. Уведомитель об остатках (`inventory_notifier_worker.js`)

-   **Назначение**: Агрегирует все изменения на складах (центральном и в аппаратах) и отправляет пользователям сводный отчет.
-   **Расписание**: Запускается каждый час.
-   **Функциональность**:
    -   Собирает данные из таблицы `inventory_change_log`.
    -   Группирует изменения по месту (Склад или конкретная Стойка).
    -   Формирует единое, структурированное сообщение.
    -   Автоматически разбивает слишком длинные сообщения на несколько частей, чтобы обойти лимиты Telegram.
-   **Технические нюансы**:
    -   Отмечает записи в логе как `is_notified = true`, чтобы не отправлять повторные уведомления.

### 2.4. Очистка задач (`task_cleanup_worker.js`)

-   **Назначение**: Поддерживает чистоту в списке активных задач, скрывая старые выполненные задачи.
-   **Расписание**: Каждый день в 23:59 по московскому времени.
-   **Функциональность**:
    -   Находит все задачи, выполненные до начала текущего дня.
    -   Вместо удаления, просто скрывает их из основного списка задач в UI (логика фильтрации в `GET /api/tasks`).
    -   Сохраняет задачи в базе данных для будущей аналитики.
-   **Технические нюансы**:
    -   Использует `moment-timezone` для корректной работы с московским временем независимо от часового пояса сервера.

### 2.5. Проверка статуса оплаты (`payment_status_checker_worker.js`) - НОВЫЙ

-   **Назначение**: Автоматически восстанавливает работу для пользователей, которые решили проблему с оплатой подписки Vendista.
-   **Расписание**: Каждый день в 04:00 по московскому времени.
-   **Функциональность**:
    1.  Находит всех пользователей со статусом `vendista_payment_status = 'payment_required'`.
    2.  Для каждого пользователя делает тестовый запрос к API Vendista (пытается получить новый токен).
    3.  **В случае успеха**:
        -   Меняет статус пользователя обратно на `active`.
        -   Сохраняет новый, свежий токен Vendista.
        -   Отправляет администратору уведомление об успешной реактивации.
    4.  **В случае неудачи**: Ничего не делает, оставляя пользователя в прежнем статусе до следующей проверки.
-   **Технические нюансы**:
    -   Является ключевым компонентом для автоматического восстановления системы после сбоев оплаты.

---

## 3. Система отслеживания статуса оплаты Vendista

Это не отдельный воркер, а сквозная система, интегрированная во все процессы, работающие с API Vendista.

-   **Принцип работы**:
    -   Если любой запрос к API Vendista возвращает ошибку `402 Payment Required`, система немедленно обновляет статус пользователя в таблице `users` на `payment_required`.
    -   Администратору отправляется **однократное** уведомление о проблеме.
    -   Все последующие запуски воркеров (импорт, синхронизация) будут **игнорировать** этого пользователя, предотвращая спам ошибками.
-   **Восстановление**: Автоматическое восстановление происходит с помощью воркера `payment_status_checker_worker.js`. Ручное восстановление возможно через `POST /api/auth/reset-payment-status`.
-   **Статусы**:
    -   `active`: Нормальная работа.
    -   `payment_required`: Требуется оплата, операции для пользователя приостановлены.

API Endpoints (Backend)

Этот документ описывает все основные API-эндпоинты, реализованные на бэкенде. Для каждого эндпоинта указан HTTP-метод, путь, назначение, ожидаемые параметры (включая заголовки, тело запроса, параметры URL) и особенности, связанные с различными средами (development/production).

---

1.  Аутентификация и пользователи

    1.1. POST /api/auth/telegram-handshake
        - Назначение: **(ВАЖНО) Только для первичной аутентификации.** Используется, когда пользователь заходит в приложение впервые или после полного выхода (очистки localStorage). Этот эндпоинт определяет, является ли пользователь новым, и при необходимости инициирует процесс регистрации.
        - **Ключевые изменения (ВАЖНО!):**
            - Production: Теперь **корректно определяет роли 'admin' и 'service'**, проверяя таблицу `user_access_rights` в дополнение к таблице `users`. Если пользователь существует в `user_access_rights` (как 'admin' или 'service'), но не имеет полной регистрации `owner` в `users`, ему будет выдан токен с соответствующим `access_level` без требования регистрации. **Ключевым для стабильной аутентификации в Production является точное определение роли пользователя (owner, admin, service) на основе данных из таблиц `users` и `user_access_rights`. Система теперь четко дифференцирует:
                - `owner`: определяется по наличию записи в `users` с заполненным `vendista_api_token`.
                - `admin`/`service`: определяются по наличию записи в `user_access_rights` (даже если у них нет полной регистрации `owner` в `users`).
                Такая идентификация ролей критически важна для предоставления правильных прав доступа и предотвращения ошибок, связанных с некорректной интерпретацией статуса пользователя.**
            - Production: `telegram_id` теперь приводится к строковому типу (`.toString()`) перед использованием в запросах к БД для устранения потенциальных проблем с типами данных (`bigint`) и `duplicate key` ошибок.
            - Весь эндпоинт обернут в `try-catch` блок для перехвата любых неожиданных ошибок, которые теперь автоматически отправляются в админский чат через `sendErrorToAdmin`.
        - Особенности:
            - Production: Проверяет криптографическую подпись initData с использованием TELEGRAM_BOT_TOKEN. Не предназначен для обновления сессий существующих пользователей с ролями 'admin' или 'service', так как для этого используется `refresh-app-token`.
            - Development: Проверка подписи initData пропускается, что позволяет эмулировать вход через DevEntryPage.js. Ожидает поле `dev_role` в `user` объекте initData для эмуляции роли.
        - Входные параметры (тело запроса):
            - initData: Строка `initData` из Telegram WebApp.
        - Выходные данные (успех):
            - success: true
            - token: JWT-токен для последующих авторизованных запросов.
            - user: Объект пользователя с `id`, `telegram_id`, `access_level`.
            - message: (Только в Production) `registration_required` или `registration_incomplete`, если пользователь не завершил регистрацию `owner`.
        - Выходные данные (ошибка):
            - success: false
            - error: Сообщение об ошибке (например, 'Invalid Telegram data', 'initData is required', 'Критическая ошибка аутентификации. Администратор уведомлен.').
        - **Mistake to Avoid:**
            - **Не использовать `/telegram-handshake` для обновления истекших токенов.** Этот эндпоинт предназначен **только для первого входа**. Использование его для `admin`/`service` пользователей с истекшим токеном ранее приводило к ошибке `duplicate key` и состоянию "серого экрана", поскольку система ошибочно пыталась их зарегистрировать заново. Используйте `POST /api/auth/refresh-app-token` для обновления.
            - **Убедитесь, что `telegram_id` в initData соответствует ожидаемому типу данных (строке) при работе с PostgreSQL.**

    1.2. GET /api/auth/validate-token
        - Назначение: Валидация существующего JWT-токена и получение актуальных данных пользователя.
        - Входные параметры (заголовки):
            - Authorization: Bearer <JWT_TOKEN>
        - Особенности:
            - Всегда ищет пользователя в базе данных, чтобы вернуть актуальные данные на фронтенд.
            - В Development-режиме эндпоинт **дополнительно обрабатывает заголовок `x-emulated-role`** для эмуляции ролей (`owner`, `admin`, `service`), что позволяет тестировать различные уровни доступа без реальной смены аккаунта. Если в токене указан `accessLevel` 'admin' или 'service', эндпоинт вернет объект пользователя с соответствующими данными (имя, `telegram_id`), а не данные владельца.
        - Выходные данные (успех):
            - success: true
            - user: Полный объект пользователя из БД, дополненный `accessLevel` из токена.
        - Выходные данные (ошибка):
            - success: false
            - error: Сообщение об ошибке ('Invalid or expired token', 'User not found').

    1.3. POST /api/auth/refresh-app-token
        - Назначение: **(ВАЖНО) Для "молчаливого" обновления сессии.** Используется, когда JWT-токен пользователя истек, для получения нового токена без повторного входа. Корректно обрабатывает все роли пользователей (`owner`, `admin`, `service`).
        - Входные параметры (тело запроса):
            - initData: Строка initData из Telegram WebApp.
        - Особенности:
            - В Production-режиме initData строго валидируется.
            - В Development-режиме initData не валидируется.
        - Выходные данные (успех):
            - success: true
            - token: Новый JWT-токен.
            - user: Актуальные данные пользователя.
        - Выходные данные (ошибка):
            - success: false
            - error: Сообщение об ошибке.

    1.4. POST /api/auth/validate-vendista
        - Назначение: Валидация учетных данных Vendista API.
        - Входные параметры (тело запроса):
            - telegram_id: Telegram ID пользователя.
            - vendista_login: Логин Vendista.
            - vendista_password: Пароль Vendista.
        - Выходные данные (успех):
            - success: true
            - vendista_api_token_plain: Полученный токен Vendista (нешифрованный).
        - Выходные данные (ошибка):
            - success: false
            - error: Сообщение об ошибке (например, 'Неверный логин или пароль Vendista').

    1.5. POST /api/auth/complete-registration
        - Назначение: Завершение процесса регистрации пользователя, сохранение токена Vendista и настроек.
        - Входные параметры (тело запроса):
            - telegram_id: Telegram ID пользователя.
            - vendista_login: (Обязательно) Логин пользователя в Vendista.
            - vendista_password: (Обязательно) Пароль пользователя в Vendista.
            - vendista_api_token_plain: Нешифрованный токен Vendista.
            - setup_date: Дата установки первой кофейни.
            - tax_system: (опционально) Выбранная система налогообложения.
            - acquiring: (опционально) Процент эквайринга.
            - first_name, firstName: (опционально) Имя пользователя.
            - user_name, username: (опционально) Username пользователя.
        - Выходные данные (успех):
            - success: true
            - token: Новый JWT-токен для приложения.
            - user: Обновленные данные пользователя.
        - Выходные данные (ошибка):
            - success: false
            - error: Сообщение об ошибке.

    1.6. POST /api/log-frontend-error
        - Назначение: Прием и логирование ошибок, происходящих на фронтенде, с отправкой подробных уведомлений администратору. Служит для сбора диагностической информации напрямую с клиента.
        - Входные параметры (тело запроса):
            - error: Сообщение об ошибке.
            - context: Контекст ошибки (где произошла). **Если содержит 'CRITICAL AUTH ERROR', это автоматически помечает ошибку как критическую для администратора.**
            - tgInitData: `initData` Telegram (для дополнительной информации о пользователе).
            - userData: Данные пользователя из контекста фронтенда (`useAuth`).
            - diagnosticInfo: Объект, содержащий подробные клиентские логи (`logs`), информацию из `localStorage` (`localStorage`), данные `window.Telegram.WebApp` (`telegramWebApp`), User-Agent и URL страницы.
        - Особенности: Автоматически определяет уровень критичности на основе контекста или роли пользователя (`admin`/`service`) и отправляет уведомление в админский чат. Форматирует последние 5 записей фронтенд-логов для удобства.
        - Выходные данные (успех): success: true
        - Выходные данные (ошибка): success: false

    1.7. POST /api/auth/reset-payment-status
        - Назначение: Ручной сброс статуса оплаты Vendista для пользователя (только для администраторов).
        - Входные параметры (тело запроса):
            - userId: ID пользователя в базе данных.
        - Выходные данные (успех):
            - success: true
            - message: Сообщение о результате операции.
            - user: Объект с обновленными данными пользователя (id, telegram_id, first_name, payment_status).
        - Выходные данные (ошибка):
            - success: false
            - error: Сообщение об ошибке ('User ID is required', 'User not found', 'Internal server error').

    1.8. GET /api/auth/debug-user/:telegram_id
        - Назначение: Диагностический эндпоинт для получения полной информации о пользователе по его Telegram ID из таблиц `users` и `user_access_rights`. Помогает понять, почему пользователь попадает в тот или иной сценарий аутентификации.
        - Особенности: Доступен только в `development` режиме. В `production` режиме требует авторизации с `owner` доступом.
        - Входные параметры (URL):
            - :telegram_id: Telegram ID пользователя для диагностики.
        - Входные параметры (заголовки, только для production): `Authorization: Bearer <JWT_TOKEN>` (токен `owner` пользователя).
        - Выходные данные (успех):
            - success: true
            - diagnostic: Объект с информацией о пользователе (`telegram_id`, `timestamp`, `found_in_users`, `found_in_access_rights`, `user_data`, `access_rights_data`, `recommended_flow`).
        - Выходные данные (ошибка): success: false, error

    1.9. POST /api/auth/test-initdata
        - Назначение: Диагностический эндпоинт для проверки валидности строки `initData` Telegram. Позволяет тестировать `initData` без необходимости запуска всего фронтенда.
        - Особенности: **Доступен только в `development` режиме.**
        - Входные параметры (тело запроса):
            - initData: Строка `initData` для проверки.
        - Выходные данные (успех):
            - success: true
            - test_result: Объект с результатом валидации (`valid`, `error`, `user_data`, `environment`, `has_bot_token`).
        - Выходные данные (ошибка): success: false, error

    1.10. GET /api/auth/auth-stats
        - Назначение: Диагностический эндпоинт для получения общей статистики по пользователям и их ролям в системе, а также количества ошибок аутентификации за последние 24 часа.
        - Особенности: Доступен только для авторизованных `owner` пользователей.
        - Входные параметры (заголовки): `Authorization: Bearer <JWT_TOKEN>` (токен `owner` пользователя).
        - Выходные данные (успех):
            - success: true
            - stats: Объект со статистикой (`timestamp`, `total_owners`, `incomplete_registrations`, `access_rights_by_level`, `recent_auth_errors_24h`, `environment`).
        - Выходные данные (ошибка): success: false, error

2.  Терминалы (Стойки)

    2.1. GET /api/terminals/
        - Назначение: Получение списка всех активных терминалов (стоек) для аутентифицированного пользователя.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - terminals: Массив объектов терминалов, включая флаги needs_containers_config и needs_recipes_config.
              needs_containers_config: true, если есть контейнеры без заданного max_stock > 0.
              needs_recipes_config: true, если есть нескрытые напитки без ингредиентов.
              Примечание: Поле r.is_hidden для фильтрации нескрытых напитков в запросе теперь опционально, что позволяет избежать ошибки, если поле отсутствует в БД.
        - Выходные данные (ошибка): success: false, error

    2.2. GET /api/terminals/:internalId/settings
        - Назначение: Получение настроек инвентаря (остатков) для конкретного терминала.
        - Входные параметры (URL):
            - :internalId: Внутренний ID терминала.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - settings: Массив объектов инвентаря.
        - Выходные данные (ошибка): success: false, error

    2.3. POST /api/terminals/:internalId/settings
        - Назначение: Сохранение/обновление настроек инвентаря для терминала (контейнеров).
        - Входные параметры (URL):
            - :internalId: Внутренний ID терминала.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Входные параметры (тело запроса):
            - inventorySettings: Массив объектов { item_name, max_stock, critical_stock }.
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    2.4. POST /api/terminals/copy-settings
        - Назначение: Копирование настроек контейнеров с одного терминала на несколько других.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Входные параметры (тело запроса):
            - sourceInternalId: ID исходного терминала.
            - destinationInternalIds: Массив ID целевых терминалов.
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    2.5. GET /api/terminals/:internalId/machine-items
        - Назначение: Получение списка уникальных ID напитков/товаров (machine_item_id) для терминала из транзакций.
        - Входные параметры (URL):
            - :internalId: Внутренний ID терминала.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - machineItems: Массив уникальных machine_item_id.
        - Выходные данные (ошибка): success: false, error

    2.6. POST /api/terminals/:internalId/recipes
        - Назначение: Обновление рецептов для указанного терминала.
        - Входные параметры (URL):
            - :internalId: Внутренний ID терминала.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Входные параметры (тело запроса):
            - recipes: Массив объектов рецептов. Каждый объект должен содержать:
                - machine_item_id: ID напитка/товара.
                - name: Название напитка.
                - items: Массив ингредиентов { item_name, quantity }.
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

3.  Инвентарь

    3.1. GET /api/inventory?location={location}&terminal_id={id}
        - Назначение: Универсальный эндпоинт для получения информации об инвентаре.
        - Входные параметры (URL-параметры):
            - location: `warehouse` для центрального склада, `stand` или `machine` для инвентаря стойки.
            - terminal_id: (Обязательно, если location=`stand` или `machine`) Внутренний ID терминала.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - warehouseStock: (если location=warehouse) Массив объектов инвентаря склада.
            - standStock: (если location=stand) Массив объектов инвентаря стойки.
        - Выходные данные (ошибка): success: false, error (например, 'Параметр 'location' обязателен.').

    3.2. POST /api/inventory/move
        - Назначение: Перемещение указанного количества товара между двумя локациями.
        - Входные параметры (тело запроса):
            - item_name: Название товара.
            - quantity: Количество для перемещения.
            - from: Объект источника { location: "warehouse" | "stand" | "machine", terminal_id?: number }.
            - to: Объект назначения { location: "warehouse" | "stand" | "machine", terminal_id?: number }.
        - Особенности: Требует уровня доступа owner, admin или service.
        - Выходные данные (успех): success: true, message, updatedStock: { from, to }
        - Выходные данные (ошибка): success: false, error

4.  Задачи

    4.1. GET /api/tasks
        - Назначение: Получение списка всех сервисных задач.
        - Фильтрация: Выполненные задачи автоматически скрываются из журнала, если они были завершены до начала текущего календарного дня по московскому времени. Задачи остаются в базе данных для аналитики.
        - Логика фильтрации:
            * Показывает все задачи со статусом 'pending'
            * Показывает задачи со статусом 'completed', завершенные с начала текущего дня по московскому времени
            * Использует moment().tz('Europe/Moscow').startOf('day').utc() для определения границы
            * SQL: WHERE t.status = 'pending' OR t.completed_at >= $moscowStartOfDay
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - tasks: Массив объектов задач.
        - Выходные данные (ошибка): success: false, error

    4.2. GET /api/tasks/my
        - Назначение: Получение списка задач, назначенных текущему пользователю.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - tasks: Массив объектов задач, дополненных полем `ingredients` (массив объектов { name, percentage, critical }) для задач типа 'restock'.
        - Выходные данные (ошибка): success: false, error

    4.3. POST /api/tasks/create-manual
        - Назначение: Создание новой сервисной задачи вручную. Позволяет создавать одну или несколько задач одновременно.
        - Входные параметры (тело запроса):
            - tasks: Массив объектов задач. Каждый объект должен содержать:
                - terminalId: ID терминала, к которому относится задача.
                - taskType: (Больше не используется, бэкенд всегда ставит 'restock')
                - assigneeId: Telegram ID назначенного исполнителя.
                - comment: (Опционально) Комментарий к задаче.
        - Особенности: Автоматически добавляет `details: { is_manual: true }` и `task_type: 'restock'` к создаваемым задачам. Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    4.4. POST /api/tasks/:taskId/complete
        - Назначение: Завершение задачи.
        - Входные параметры (URL):
            - :taskId: ID задачи.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Входные параметры (тело запроса):
            - updatedStock: (Обязательно для задач 'restock') Массив объектов { item_name, current_stock }. Представляет собой новые остатки ингредиентов в машине после пополнения.
        - Особенности:
            - Для задач типа 'restock':
                - Если задача была создана вручную (details.is_manual = true): Задача будет завершена, если был пополнен хотя бы один ингредиент (current_stock > quantity_before).
                - Если задача была создана системой: Задача будет завершена только в том случае, если все ингредиенты, которые были на критическом уровне ДО пополнения, теперь пополнены выше этого критического уровня.
                - При успешном завершении любой задачи на пополнение ('restock'), счетчик `sales_since_cleaning` для соответствующего терминала автоматически сбрасывается на 0.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    4.5. DELETE /api/tasks/:taskId
        - Назначение: Удаление задачи.
        - Входные параметры (URL):
            - :taskId: ID задачи для удаления.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    4.6. POST /api/tasks/:taskId/comment
        - Назначение: Добавление комментария к задаче.
        - Входные параметры (URL):
            - :taskId: ID задачи.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Входные параметры (тело запроса):
            - comment: Текст комментария.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    4.7. GET /api/tasks/settings
        - Назначение: Получение настроек сервисных задач (assignee_id_restock) для всех терминалов пользователя.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - settings: Массив объектов настроек, дополненных полем `needs_containers_config` (boolean), указывающим, требуется ли настройка контейнеров, и `sales_since_cleaning` для отображения количества продаж.
        - Выходные данные (ошибка): success: false, error

    4.8. POST /api/tasks/settings
        - Назначение: Сохранение/обновление настроек сервисных задач для терминала.
        - Входные параметры (тело запроса):
            - terminal_id: ID терминала.
            - assignee_id_restock: (Опционально) Telegram ID назначенного для пополнения.
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    4.9. GET /api/tasks/restock-info
        - Назначение: Получение информации о товарах, требующих пополнения для текущего пользователя.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - restockInfo: Массив объектов { item_name, current_stock, critical_stock, terminal_id, terminal_name }.
        - Выходные данные (ошибка): success: false, error

5.  Профиль

    5.1. GET /api/profile/settings
        - Назначение: Получение текущих настроек профиля пользователя.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - settings: Объект с настройками пользователя (setup_date, tax_system, acquiring).
        - Выходные данные (ошибка): success: false, error

    5.2. POST /api/profile/settings
        - Назначение: Обновление настроек профиля пользователя.
        - Входные параметры (тело запроса):
            - tax_system: (Опционально) Выбранная система налогообложения ('income_6', 'income_expense_15' или null для сброса).
            - acquiring: (Опционально) Процент эквайринга (число от 0 до 100, или null для сброса).
            - setup_date: (Опционально) Дата установки первой кофейни (YYYY-MM-DD или null для сброса).
        - Особенности: Требует уровня доступа owner или admin. Валидирует формат даты и диапазон процента эквайринга.
        - Выходные данные (успех):
            - success: true
            - message: Сообщение об успешном обновлении.
            - settings: Объект с обновленными настройками пользователя. **ВАЖНО: Теперь возвращает полный объект пользователя из БД, дополненный `accessLevel` из JWT токена. Это обеспечивает корректную синхронизацию состояния на фронтенде.**
        - Выходные данные (ошибка): success: false, error

    5.3. GET /api/profile/sync-status
        - Назначение: Получение статуса синхронизации данных из Vendista для текущего пользователя.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - last_sync_time: Время последней синхронизации.
            - is_syncing: true если синхронизация активна.
        - Выходные данные (ошибка): success: false, error

6.  Транзакции

    6.1. GET /api/transactions/stats?from={dateFrom}&to={dateTo}
        - Назначение: Получение общей финансовой статистики (выручка, количество продаж, расходы) за указанный период.
        - Входные параметры (URL-параметры):
            - from: Начальная дата периода (YYYY-MM-DD).
            - to: Конечная дата периода (YYYY-MM-DD).
            - terminalId: (Опционально) Внутренний ID терминала для фильтрации транзакций по конкретной кофейне. Использует `coffee_shop_id` из таблицы `transactions`.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - stats: Объект со статистикой (revenue, salesCount, expensesSum).
        - Выходные данные (ошибка): success: false, error

    6.2. GET /api/transactions/coffee-stats?from={dateFrom}&to={dateTo}
        - Назначение: Получение статистики по продажам для каждой кофейни за указанный период.
        - Входные параметры (URL-параметры):
            - from: Начальная дата периода (YYYY-MM-DD).
            - to: Конечная дата периода (YYYY-MM-DD).
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - stats: Массив объектов статистики по кофейням.
        - Выходные данные (ошибка): success: false, error

7.  Расходы

    7.1. GET /api/expenses
        - Назначение: Получение списка всех расходов пользователя.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех):
            - success: true
            - expenses: Массив объектов расходов.
        - Выходные данные (ошибка): success: false, error

    7.2. POST /api/expenses
        - Назначение: Добавление нового расхода.
        - Входные параметры (тело запроса):
            - amount: Сумма расхода.
            - comment: Комментарий.
            - expense_time: Дата и время расхода.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    7.3. DELETE /api/expenses/:expenseId
        - Назначение: Удаление расхода по ID.
        - Входные параметры (URL):
            - :expenseId: ID расхода.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

8.  Доступы

    8.1. GET /api/access
        - Назначение: Получение списка всех пользователей, которым текущий пользователь предоставил доступ.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех):
            - success: true
            - access_list: Массив объектов прав доступа.
        - Выходные данные (ошибка): success: false, error

    8.2. POST /api/access
        - Назначение: Предоставление доступа новому пользователю.
        - Входные параметры (тело запроса):
            - telegram_id: Telegram ID пользователя, которому предоставляется доступ.
            - access_level: Уровень доступа ('admin' или 'service').
            - shared_with_name: Имя пользователя.
            - can_receive_stock_notifications: (Опционально) Будет ли получать уведомления о запасах.
            - can_receive_service_notifications: (Опционально) Будет ли получать уведомления о сервисе.
            - assigned_terminals_stock: (Опционально) Массив ID терминалов для запасов.
            - assigned_terminals_service: (Опционально) Массив ID терминалов для сервиса.
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    8.3. PUT /api/access/:accessId
        - Назначение: Обновление прав доступа для существующей записи.
        - Входные параметры (URL):
            - :accessId: ID записи доступа.
        - Входные параметры (тело запроса): Те же, что и для POST /api/access, но все поля опциональны.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    8.4. DELETE /api/access/:accessId
        - Назначение: Удаление прав доступа.
        - Входные параметры (URL):
            - :accessId: ID записи доступа.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех): success: true, message
        - Выходные данные (ошибка): success: false, error

    8.5. GET /api/access/users/list
        - Назначение: Получение списка всех пользователей, имеющих права доступа к данным текущего владельца, включая их Telegram ID и имена.
        - Входные параметры (заголовки): Authorization: Bearer <JWT_TOKEN>
        - Особенности: Требует уровня доступа owner или admin.
        - Выходные данные (успех):
            - success: true
            - users: Массив объектов { id, shared_with_telegram_id, shared_with_name, access_level }.
        - Выходные данные (ошибка): success: false, error

9.  Конфигурация (только для Development)

    9.1. GET /api/dev-config
        - Назначение: Предоставляет тестовые Telegram ID для эмуляции ролей в режиме разработки.
        - Особенности: Доступен только в development-режиме.
        - Выходные данные (успех):
            - success: true
            - ownerTelegramId: Тестовый Telegram ID владельца.
            - adminTelegramId: Тестовый Telegram ID администратора.
            - serviceTelegramId: Тестовый Telegram ID сервис-инженера.
        - Выходные данные (ошибка): success: false, error (в Production)

10. Воркеры и автоматизация

    10.1. Task Cleanup Worker (backend/worker/task_cleanup_worker.js)
        - Назначение: Автоматическое скрытие выполненных задач из журнала задач.
        - Расписание: Каждый день в 23:59 по московскому времени (cron: '59 23 * * *')
        - Функциональность:
            * Подсчитывает количество completed задач, завершенных до начала текущего дня
            * Подсчитывает общее количество completed задач в системе
            * Записывает статистику в таблицу worker_logs
            * Логирует результат в консоль приложения
            * Отправляет уведомления об ошибках администраторам
        - Интеграция: Подключается автоматически при запуске приложения через app.js
        - Логирование: Записи в worker_logs с job_name = 'task_cleanup'
        - Timezone: Europe/Moscow
        - Тестирование: Функция logTaskCleanup() может быть вызвана вручную для тестирования

    10.2. Vendista Payment Status Tracking System
        - Назначение: Система отслеживания статуса оплаты Vendista для предотвращения спама уведомлений.
        - Функциональность:
            * Отслеживает статус оплаты каждого пользователя в поле `vendista_payment_status`
            * При получении ошибки 402 от Vendista API устанавливает статус `payment_required`
            * Отправляет одно уведомление администратору и пропускает пользователя в следующих запусках
            * Автоматически сбрасывает статус на `active` при успешном API-вызове
        - Интеграция: Встроена в все воркеры, работающие с Vendista API:
            * `terminal_sync_worker.js` - синхронизация терминалов
            * `vendista_import_worker.js` - импорт транзакций
            * `schedule_imports.js` - планировщик импортов
        - Управление:
            * Ручной сброс статуса через `POST /api/auth/reset-payment-status`
            * Мониторинг через SQL-запросы к таблице `users`
        - Статусы:
            * `'active'` - нормальная работа (по умолчанию)
            * `'payment_required'` - требуется оплата, пользователь пропускается
            * `'notified'` - зарезервировано для будущих улучшений 
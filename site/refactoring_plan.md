# План рефакторинга системы выделения элементов (Mockup Selection System)

## 1. Оценка предложенного подхода

### Производительность (GPU/Composite Layers)
*   **Плюсы:** Переход от `path()` к `clip-path: inset()` значительно снижает нагрузку на CPU, так как браузеру проще рассчитывать геометрию прямоугольника с закруглениями.
*   **Слои:** Использование `pointer-events: none` для всего контейнера оверлея — верное решение, исключающее конфликты с интерактивными элементами под ним.
*   **Риски (Backdrop Filter):** `backdrop-filter: blur` является ресурсоемкой операцией. На мобильных устройствах или при быстрой анимации перемещения "дырки" возможны микро-фризы.
    *   *Рекомендация:* Предусмотреть возможность отключения блюра через медиа-запрос `(prefers-reduced-motion)` или для слабых GPU.

### Скролл и мобильные устройства
*   **Скролл:** Так как элементы находятся внутри скролл-контейнера `app-scroll-area`, необходимо продолжать использовать `requestAnimationFrame` для синхронизации координат при событии `scroll`.
*   **Мобильные устройства:** На тач-экранах ховер-эффекты ведут себя иначе. Система будет работать корректно, но визуальный отклик будет происходить только в момент нажатия (tap), а не при наведении.

---

## 2. Список затрагиваемых файлов

Для реализации архитектуры «Двойного слоя» потребуется внести изменения в следующие файлы:

1.  `src/components/IPhoneMockup/IPhoneMockup.astro`
    *   **Структура:** Замена `.spotlightOverlay` на новый контейнер с двумя дочерними элементами (Backdrop и Stroke).
    *   **Логика (JS):** 
        *   Обновление функции `syncSpotlight` для работы с `clip-path: inset()`.
        *   Реализация Anti-Flicker логики (таймер на 100мс при переходе между элементами).
        *   Расчет динамического `border-radius` для дырки (радиус элемента + padding).

2.  `src/components/IPhoneMockup/IPhoneMockup.scss`
    *   Удаление старых стилей для `.spotlightOverlay`.
    *   Удаление `transform: scale` и `border` у `[data-highlight].highlighted` (теперь это делает оверлей).
    *   Добавление стилей для новых слоев:
        *   `.selection-backdrop`: затемнение и `clip-path`.
        *   `.selection-stroke`: рамка, позиционируемая через `transform: translate(x, y)`.

3.  `src/styles/_vars.scss`
    *   (Опционально) Добавление переменной `$selection-padding: 6px;` для централизованного управления "виртуальным увеличением".

---

## 3. Edge Cases и нюансы реализации

*   **Сложные формы:** `clip-path: inset` ограничен прямоугольниками. Если в будущем появятся круглые элементы (например, аватарки), потребуется логика переключения на `clip-path: circle()`.
*   **Концентрические радиусы:** Чтобы рамка выглядела гармонично, радиус скругления оверлея должен рассчитываться по формуле: `R_overlay = R_element + Padding`.
*   **Z-index:** Новый слой Stroke должен находиться выше Backdrop, но ниже плавающих элементов интерфейса, таких как `statusBarBlur`, чтобы не перекрывать их.
*   **Layout Thrashing:** Поскольку мы читаем `getBoundingClientRect()` при скролле, важно минимизировать запись в DOM в том же кадре. Использование `transform` и `clip-path` (композитные свойства) минимизирует риски.

---

## Резюме
Подход с **Dual-Layer Overlay** является оптимальным: он избавляет от проблем с `z-index` внутри плиток, предотвращает Layout Thrashing от `scale` и дает полный контроль над визуальным стилем подсветки. 

**Готов приступить к коду после подтверждения плана.**
